import React, {
  useState,
  useCallback,
  useMemo,
  useRef,
  useEffect,
} from "react";
import { motion, AnimatePresence } from "framer-motion";
import {
  Brain,
  Sparkles,
  Plus,
  X,
  Loader2,
  Layers,
  Zap,
  Eye,
  BarChart3,
  GitCompare,
  Network,
  Fingerprint,
} from "lucide-react";
import * as d3 from "d3";
import { analysis } from "../utils/api";

/* ================================================================== */
/*  Types (matched to new backend response)                            */
/* ================================================================== */
interface TopNeuron {
  idx: number;
  val: number;
}
interface HeadData {
  head: number;
  x_ds: number[];
  x_active: number;
  top_neurons: TopNeuron[];
}
interface LayerData {
  layer: number;
  heads: HeadData[];
}
interface WordFingerprint {
  word: string;
  layers: LayerData[];
}
interface SharedNeuron {
  layer: number;
  head: number;
  neuron: number;
  mean_activation: number;
  active_in: number;
  per_word: number[];
}
interface FingerprintResult {
  concept: string;
  words: WordFingerprint[];
  similarity: Record<string, number[][]>;
  shared_neurons: SharedNeuron[];
  model_info: { n_layers: number; n_heads: number; n_neurons: number };
}

/* ================================================================== */
/*  Preset categories                                                  */
/* ================================================================== */
const PRESETS: {
  id: string;
  name: string;
  icon: string;
  color: string;
  words: string[];
}[] = [
  {
    id: "currencies",
    name: "Currencies",
    icon: "üí∞",
    color: "from-yellow-500 to-orange-500",
    words: ["dollar", "euro", "franc", "yen"],
  },
  {
    id: "countries",
    name: "Countries",
    icon: "üåç",
    color: "from-blue-500 to-cyan-500",
    words: ["france", "germany", "spain", "italy"],
  },
  {
    id: "languages",
    name: "Languages",
    icon: "üó£Ô∏è",
    color: "from-purple-500 to-pink-500",
    words: ["anglais", "fran√ßais", "espagnol", "allemand"],
  },
  {
    id: "politics",
    name: "Politics",
    icon: "‚öñÔ∏è",
    color: "from-green-500 to-emerald-500",
    words: ["parlement", "commission", "conseil", "vote"],
  },
];

/* ================================================================== */
/*  Shared color helpers                                               */
/* ================================================================== */
function intensityColor(v: number, maxV: number): string {
  if (maxV === 0) return "rgba(139,92,246,0.05)";
  const t = Math.min(v / maxV, 1);
  if (t < 0.01) return "rgba(139,92,246,0.04)";
  const a = 0.15 + t * 0.85;
  return `rgba(139,92,246,${a.toFixed(2)})`;
}

function simColor(v: number): string {
  if (v < 0.3) return `rgba(100,100,120,${(0.1 + v).toFixed(2)})`;
  if (v < 0.6) {
    const t = (v - 0.3) / 0.3;
    return `rgba(139,92,246,${(0.2 + t * 0.5).toFixed(2)})`;
  }
  const t = (v - 0.6) / 0.4;
  const r = Math.round(16 + t * 0);
  const g = Math.round(130 + t * 55);
  const b = Math.round(180 - t * 51);
  return `rgba(${r},${g},${b},${(0.6 + t * 0.4).toFixed(2)})`;
}

const WORD_COLORS = [
  "#8b5cf6",
  "#3b82f6",
  "#10b981",
  "#f59e0b",
  "#ef4444",
  "#ec4899",
  "#06b6d4",
  "#84cc16",
];

/* ================================================================== */
/*  View type enum                                                     */
/* ================================================================== */
type ViewTab =
  | "fingerprint"
  | "similarity"
  | "intersection"
  | "crossConcept"
  | "neuronGraph";

const VIEW_TABS: { id: ViewTab; label: string; icon: React.ReactNode }[] = [
  { id: "fingerprint", label: "Fingerprint", icon: <Fingerprint size={14} /> },
  { id: "similarity", label: "Similarity", icon: <BarChart3 size={14} /> },
  { id: "intersection", label: "Intersection", icon: <Eye size={14} /> },
  {
    id: "crossConcept",
    label: "Cross-Concept",
    icon: <GitCompare size={14} />,
  },
  { id: "neuronGraph", label: "Neuron Graph", icon: <Network size={14} /> },
];

/* ================================================================== */
/*  Sub-components                                                     */
/* ================================================================== */

/** Small heatmap strip for one head */
function HeatmapRow({
  bins,
  maxVal,
  label,
  delay = 0,
  highlightBins,
}: {
  bins: number[];
  maxVal: number;
  label: string;
  delay?: number;
  highlightBins?: Set<number>;
}) {
  return (
    <motion.div
      className="flex items-center gap-1"
      initial={{ opacity: 0, x: -8 }}
      animate={{ opacity: 1, x: 0 }}
      transition={{ delay, duration: 0.3 }}
    >
      <span className="w-8 text-[10px] text-gray-500 font-mono shrink-0 text-right">
        {label}
      </span>
      <div className="flex gap-[1px] flex-1">
        {bins.map((v, i) => {
          const isHighlighted = highlightBins?.has(i);
          const bg = isHighlighted
            ? `rgba(16,185,129,${Math.max(0.3, Math.min(v / maxVal, 1)).toFixed(2)})`
            : intensityColor(v, maxVal);
          return (
            <div
              key={i}
              className="h-3 flex-1 rounded-[1px] transition-colors duration-300"
              style={{
                backgroundColor: bg,
                outline: isHighlighted
                  ? "1px solid rgba(16,185,129,0.5)"
                  : undefined,
              }}
              title={`bin ${i}: ${v.toFixed(4)}`}
            />
          );
        })}
      </div>
    </motion.div>
  );
}

/* ================================================================== */
/*  1. FINGERPRINT VIEW ‚Äî x_sparse only heatmaps                      */
/* ================================================================== */

function FingerprintView({
  result,
  selectedLayer,
  globalMax,
}: {
  result: FingerprintResult;
  selectedLayer: number;
  globalMax: number;
}) {
  return (
    <div className="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
      {result.words.map((fp, wordIdx) => {
        const layer = fp.layers.find((l) => l.layer === selectedLayer);
        if (!layer) return null;
        const color = WORD_COLORS[wordIdx % WORD_COLORS.length];
        const totalActive = layer.heads.reduce((s, h) => s + h.x_active, 0);
        return (
          <motion.div
            key={fp.word}
            className="glass-card p-4 overflow-hidden"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: wordIdx * 0.08 }}
          >
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-2">
                <div
                  className="w-3 h-3 rounded-full"
                  style={{ backgroundColor: color }}
                />
                <span className="font-mono font-bold text-lg" style={{ color }}>
                  "{fp.word}"
                </span>
              </div>
              <div className="text-xs text-gray-500 flex items-center gap-1">
                <Zap size={12} className="text-bdh-accent" />
                {totalActive.toLocaleString()} active
              </div>
            </div>
            <div className="mb-1">
              <span className="text-[10px] uppercase tracking-wider text-amber-400/70 font-semibold">
                x-path (concept fingerprint)
              </span>
              <div className="space-y-[2px] mt-1">
                {layer.heads.map((h, hi) => (
                  <HeatmapRow
                    key={hi}
                    bins={h.x_ds}
                    maxVal={globalMax}
                    label={`H${h.head}`}
                    delay={wordIdx * 0.08 + hi * 0.02}
                  />
                ))}
              </div>
            </div>
            {/* Top neurons badge row */}
            <div className="flex flex-wrap gap-1 mt-3">
              {layer.heads
                .flatMap((h) =>
                  h.top_neurons
                    .slice(0, 3)
                    .map((n) => ({ ...n, head: h.head })),
                )
                .slice(0, 8)
                .map((n, i) => (
                  <span
                    key={i}
                    className="text-[9px] font-mono px-1.5 py-0.5 rounded bg-bdh-accent/15 text-bdh-accent border border-bdh-accent/20"
                  >
                    H{n.head}_N{n.idx}
                  </span>
                ))}
            </div>
          </motion.div>
        );
      })}
    </div>
  );
}

/* ================================================================== */
/*  2. SIMILARITY MATRIX ‚Äî NxN cosine similarity grid                  */
/* ================================================================== */

function SimilarityView({
  result,
  selectedLayer,
}: {
  result: FingerprintResult;
  selectedLayer: number;
}) {
  const matrix = result.similarity[String(selectedLayer)];
  if (!matrix)
    return <p className="text-gray-500 text-sm">No data for this layer.</p>;
  const words = result.words.map((w) => w.word);
  const n = words.length;

  const avgSim = useMemo(() => {
    let sum = 0,
      count = 0;
    for (let i = 0; i < n; i++)
      for (let j = i + 1; j < n; j++) {
        sum += matrix[i][j];
        count++;
      }
    return count > 0 ? sum / count : 0;
  }, [matrix, n]);

  return (
    <motion.div
      className="glass-card p-6"
      initial={{ opacity: 0, scale: 0.95 }}
      animate={{ opacity: 1, scale: 1 }}
    >
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <BarChart3 size={16} className="text-bdh-accent" />
          <span className="text-sm font-semibold">
            Cosine Similarity Matrix ‚Äî Layer {selectedLayer}
          </span>
        </div>
        <span className="text-xs text-gray-400">
          Avg:{" "}
          <span
            className={`font-bold ${avgSim > 0.7 ? "text-emerald-400" : avgSim > 0.4 ? "text-amber-400" : "text-red-400"}`}
          >
            {avgSim.toFixed(3)}
          </span>
        </span>
      </div>
      <div className="overflow-x-auto">
        <div
          className="inline-grid gap-[2px]"
          style={{
            gridTemplateColumns: `80px repeat(${n}, minmax(60px, 1fr))`,
          }}
        >
          <div />
          {words.map((w, j) => (
            <div
              key={`h-${j}`}
              className="text-center text-xs font-mono font-semibold truncate px-1 py-2"
              style={{ color: WORD_COLORS[j % WORD_COLORS.length] }}
            >
              {w}
            </div>
          ))}
          {words.map((rowWord, i) => (
            <React.Fragment key={`row-${i}`}>
              <div
                className="text-xs font-mono font-semibold flex items-center justify-end pr-3 truncate"
                style={{ color: WORD_COLORS[i % WORD_COLORS.length] }}
              >
                {rowWord}
              </div>
              {matrix[i].map((val, j) => {
                const isDiag = i === j;
                return (
                  <motion.div
                    key={`c-${i}-${j}`}
                    className="relative flex items-center justify-center rounded-md cursor-default select-none"
                    style={{
                      backgroundColor: isDiag
                        ? "rgba(255,255,255,0.05)"
                        : simColor(val),
                      minHeight: 48,
                    }}
                    initial={{ opacity: 0, scale: 0.7 }}
                    animate={{ opacity: 1, scale: 1 }}
                    transition={{ delay: (i * n + j) * 0.015, duration: 0.25 }}
                    title={`${words[i]} ‚Üî ${words[j]}: ${val.toFixed(4)}`}
                  >
                    <span
                      className={`text-sm font-mono font-bold ${isDiag ? "text-gray-600" : val > 0.7 ? "text-white" : val > 0.4 ? "text-gray-200" : "text-gray-400"}`}
                    >
                      {isDiag ? "‚Äî" : val.toFixed(2)}
                    </span>
                  </motion.div>
                );
              })}
            </React.Fragment>
          ))}
        </div>
      </div>
      {/* Legend */}
      <div className="flex items-center gap-2 mt-4">
        <span className="text-[10px] text-gray-500">Low</span>
        <div className="flex-1 h-3 rounded-full overflow-hidden flex">
          {Array.from({ length: 20 }, (_, i) => (
            <div
              key={i}
              className="flex-1 h-full"
              style={{ backgroundColor: simColor(i / 19) }}
            />
          ))}
        </div>
        <span className="text-[10px] text-gray-500">High</span>
      </div>
      {avgSim > 0.6 && (
        <motion.div
          className="mt-4 p-3 rounded-xl bg-emerald-500/10 border border-emerald-500/20"
          initial={{ opacity: 0, y: 8 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.3 }}
        >
          <p className="text-xs text-emerald-300">
            <Sparkles size={12} className="inline mr-1" />
            High average similarity ({avgSim.toFixed(3)}) confirms these words
            activate overlapping neuron populations ‚Äî strong evidence of{" "}
            <strong>monosemantic encoding</strong>.
          </p>
        </motion.div>
      )}
    </motion.div>
  );
}

/* ================================================================== */
/*  3. INTERSECTION VIEW ‚Äî highlight shared neurons vs reference word  */
/* ================================================================== */

function IntersectionView({
  result,
  selectedLayer,
  globalMax,
}: {
  result: FingerprintResult;
  selectedLayer: number;
  globalMax: number;
}) {
  const [refIdx, setRefIdx] = useState(0);
  const words = result.words;
  const refWord = words[refIdx];
  if (!refWord) return null;

  const refLayer = refWord.layers.find((l) => l.layer === selectedLayer);
  if (!refLayer) return null;

  const refActiveBins: Map<number, Set<number>> = useMemo(() => {
    const m = new Map<number, Set<number>>();
    refLayer.heads.forEach((h) => {
      const s = new Set<number>();
      const thresh = globalMax * 0.12;
      h.x_ds.forEach((v, i) => {
        if (v > thresh) s.add(i);
      });
      m.set(h.head, s);
    });
    return m;
  }, [refLayer, globalMax]);

  return (
    <div className="space-y-4">
      {/* Reference selector */}
      <motion.div
        className="glass-card p-4"
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
      >
        <div className="flex items-center gap-3 flex-wrap">
          <span className="text-xs text-gray-400 font-semibold uppercase tracking-wider">
            Reference word:
          </span>
          {words.map((w, i) => (
            <button
              key={w.word}
              onClick={() => setRefIdx(i)}
              className={`px-3 py-1.5 rounded-lg text-sm font-mono font-semibold transition-all border ${
                i === refIdx
                  ? "bg-emerald-500/20 border-emerald-500/50 text-emerald-400"
                  : "bg-gray-800/50 border-gray-700 text-gray-400 hover:border-gray-600 hover:text-gray-200"
              }`}
            >
              {w.word}
            </button>
          ))}
        </div>
        <p className="text-[11px] text-gray-500 mt-2">
          <span className="inline-block w-3 h-2 rounded-[1px] bg-emerald-500/60 mr-1 align-middle" />
          Green = shared with <strong>"{refWord.word}"</strong>
          <span className="inline-block w-3 h-2 rounded-[1px] bg-gray-600/30 ml-3 mr-1 align-middle" />
          Dim = unique to this word
        </p>
      </motion.div>

      {/* Reference word */}
      <motion.div
        className="glass-card p-4 border-l-2 border-emerald-500"
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.05 }}
      >
        <div className="flex items-center gap-2 mb-2">
          <div
            className="w-3 h-3 rounded-full"
            style={{
              backgroundColor: WORD_COLORS[refIdx % WORD_COLORS.length],
            }}
          />
          <span
            className="font-mono font-bold text-lg"
            style={{ color: WORD_COLORS[refIdx % WORD_COLORS.length] }}
          >
            "{refWord.word}"
          </span>
          <span className="text-[10px] uppercase tracking-wider text-emerald-400 font-semibold ml-2">
            REFERENCE
          </span>
        </div>
        <div className="space-y-[2px]">
          {refLayer.heads.map((h, hi) => (
            <HeatmapRow
              key={hi}
              bins={h.x_ds}
              maxVal={globalMax}
              label={`H${h.head}`}
              delay={hi * 0.02}
            />
          ))}
        </div>
      </motion.div>

      {/* Comparison words */}
      {words
        .filter((_, i) => i !== refIdx)
        .map((fp, ci) => {
          const layer = fp.layers.find((l) => l.layer === selectedLayer);
          if (!layer) return null;
          const origIdx = words.indexOf(fp);
          const color = WORD_COLORS[origIdx % WORD_COLORS.length];

          let sharedCount = 0,
            totalActive = 0;
          layer.heads.forEach((h) => {
            const refSet = refActiveBins.get(h.head);
            h.x_ds.forEach((v, i) => {
              if (v > globalMax * 0.12) {
                totalActive++;
                if (refSet?.has(i)) sharedCount++;
              }
            });
          });
          const overlapPct =
            totalActive > 0
              ? ((sharedCount / totalActive) * 100).toFixed(0)
              : "0";

          return (
            <motion.div
              key={fp.word}
              className="glass-card p-4 overflow-hidden"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: ci * 0.08 + 0.1 }}
            >
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-2">
                  <div
                    className="w-3 h-3 rounded-full"
                    style={{ backgroundColor: color }}
                  />
                  <span
                    className="font-mono font-bold text-lg"
                    style={{ color }}
                  >
                    "{fp.word}"
                  </span>
                </div>
                <span className="text-xs font-semibold text-emerald-400">
                  {overlapPct}% overlap
                </span>
              </div>
              <div className="space-y-[2px]">
                {layer.heads.map((h, hi) => (
                  <HeatmapRow
                    key={hi}
                    bins={h.x_ds}
                    maxVal={globalMax}
                    label={`H${h.head}`}
                    delay={ci * 0.08 + hi * 0.02 + 0.1}
                    highlightBins={refActiveBins.get(h.head)}
                  />
                ))}
              </div>
            </motion.div>
          );
        })}
    </div>
  );
}

/* ================================================================== */
/*  4. CROSS-CONCEPT VIEW ‚Äî probe two categories, compare             */
/* ================================================================== */

function CrossConceptView({
  primaryResult,
  onProbeSecondary,
}: {
  primaryResult: FingerprintResult;
  onProbeSecondary: (
    name: string,
    words: string[],
  ) => Promise<FingerprintResult | null>;
}) {
  const [secondaryResult, setSecondaryResult] =
    useState<FingerprintResult | null>(null);
  const [loading, setLoading] = useState(false);
  const [selectedPreset, setSelectedPreset] = useState<string | null>(null);
  const [comparisonLayer, setComparisonLayer] = useState(0);

  const availablePresets = PRESETS.filter(
    (p) => p.name.toLowerCase() !== primaryResult.concept.toLowerCase(),
  );

  const probeSecondary = async (preset: (typeof PRESETS)[number]) => {
    setLoading(true);
    setSelectedPreset(preset.id);
    try {
      const res = await onProbeSecondary(preset.name, preset.words);
      setSecondaryResult(res);
    } finally {
      setLoading(false);
    }
  };

  const nLayers = primaryResult.model_info.n_layers;

  // Compute distinctness via Jaccard distance on top neuron sets
  const distinctness = useMemo(() => {
    if (!secondaryResult) return null;
    const layerScores: number[] = [];
    for (let l = 0; l < nLayers; l++) {
      const primaryNeurons = new Set<string>();
      primaryResult.words.forEach((w) => {
        const layer = w.layers.find((la) => la.layer === l);
        layer?.heads.forEach((h) => {
          h.top_neurons.forEach((n) =>
            primaryNeurons.add(`${h.head}_${n.idx}`),
          );
        });
      });
      const secondaryNeurons = new Set<string>();
      secondaryResult.words.forEach((w) => {
        const layer = w.layers.find((la) => la.layer === l);
        layer?.heads.forEach((h) => {
          h.top_neurons.forEach((n) =>
            secondaryNeurons.add(`${h.head}_${n.idx}`),
          );
        });
      });
      const intersection = [...primaryNeurons].filter((n) =>
        secondaryNeurons.has(n),
      ).length;
      const union = new Set([...primaryNeurons, ...secondaryNeurons]).size;
      layerScores.push(union > 0 ? 1 - intersection / union : 1);
    }
    return layerScores;
  }, [primaryResult, secondaryResult, nLayers]);

  return (
    <div className="space-y-4">
      <motion.div
        className="glass-card p-4"
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
      >
        <div className="flex items-center gap-2 mb-3">
          <GitCompare size={16} className="text-bdh-accent" />
          <span className="text-sm font-semibold">
            Compare with another concept
          </span>
        </div>
        <p className="text-xs text-gray-500 mb-3">
          Primary:{" "}
          <span className="text-bdh-accent font-bold">
            {primaryResult.concept}
          </span>{" "}
          ({primaryResult.words.map((w) => w.word).join(", ")}). Pick a second
          category to prove{" "}
          <span className="text-white">
            different concepts fire different neurons
          </span>
          .
        </p>
        <div className="flex flex-wrap gap-2">
          {availablePresets.map((p) => (
            <button
              key={p.id}
              onClick={() => probeSecondary(p)}
              disabled={loading}
              className={`px-3 py-1.5 rounded-lg text-xs font-medium border transition-all ${
                selectedPreset === p.id
                  ? "border-bdh-accent bg-bdh-accent/20 text-bdh-accent"
                  : "border-gray-700 bg-gray-800/50 text-gray-400 hover:border-gray-600 hover:text-gray-200"
              } disabled:opacity-40`}
            >
              <span className="mr-1">{p.icon}</span>
              {p.name}
              {loading && selectedPreset === p.id && (
                <Loader2 size={12} className="inline ml-1.5 animate-spin" />
              )}
            </button>
          ))}
        </div>
      </motion.div>

      {secondaryResult && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.1 }}
        >
          {/* Layer selector */}
          <div className="flex items-center gap-1 bg-gray-900/60 rounded-xl p-1 border border-gray-800/50 mb-4 w-fit">
            <Layers size={14} className="text-gray-500 ml-2 mr-1" />
            {Array.from({ length: nLayers }, (_, i) => (
              <button
                key={i}
                onClick={() => setComparisonLayer(i)}
                className={`px-3 py-1.5 rounded-lg text-xs font-mono font-semibold transition-all ${comparisonLayer === i ? "bg-bdh-accent text-white shadow-lg shadow-bdh-accent/30" : "text-gray-400 hover:text-gray-200 hover:bg-gray-800/50"}`}
              >
                L{i}
              </button>
            ))}
          </div>

          {/* Distinctness bars */}
          {distinctness && (
            <motion.div
              className="glass-card p-4 mb-4"
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
            >
              <span className="text-xs text-gray-400 font-semibold uppercase tracking-wider">
                Neuron Distinctness per Layer
              </span>
              <p className="text-[10px] text-gray-600 mb-3">
                Higher = concepts use more different neurons (1 ‚àí Jaccard
                overlap)
              </p>
              <div className="flex items-end gap-2 h-20">
                {distinctness.map((d, i) => (
                  <motion.div
                    key={i}
                    className="flex-1 flex flex-col items-center gap-1"
                    initial={{ scaleY: 0 }}
                    animate={{ scaleY: 1 }}
                    transition={{ delay: i * 0.05, duration: 0.4 }}
                    style={{ transformOrigin: "bottom" }}
                  >
                    <div
                      className="w-full rounded-t-md"
                      style={{
                        height: `${d * 100}%`,
                        backgroundColor:
                          d > 0.7
                            ? "rgba(16,185,129,0.7)"
                            : d > 0.4
                              ? "rgba(245,158,11,0.7)"
                              : "rgba(239,68,68,0.5)",
                      }}
                    />
                    <span className="text-[9px] font-mono text-gray-500">
                      L{i}
                    </span>
                  </motion.div>
                ))}
              </div>
              <p className="text-[10px] text-gray-500 mt-2">
                Avg:{" "}
                <span className="text-white font-bold">
                  {(
                    distinctness.reduce((a, b) => a + b, 0) /
                    distinctness.length
                  ).toFixed(3)}
                </span>
              </p>
            </motion.div>
          )}

          {/* Side-by-side heatmaps */}
          <div className="grid gap-4 md:grid-cols-2">
            <div className="space-y-3">
              <span className="text-xs font-bold text-bdh-accent uppercase tracking-wider">
                {primaryResult.concept}
              </span>
              {primaryResult.words.map((fp, i) => {
                const layer = fp.layers.find(
                  (l) => l.layer === comparisonLayer,
                );
                if (!layer) return null;
                return (
                  <motion.div
                    key={fp.word}
                    className="glass-card p-3"
                    initial={{ opacity: 0, x: -10 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: i * 0.05 }}
                  >
                    <span
                      className="text-xs font-mono font-bold block mb-1"
                      style={{ color: WORD_COLORS[i % WORD_COLORS.length] }}
                    >
                      {fp.word}
                    </span>
                    {layer.heads.map((h) => (
                      <HeatmapRow
                        key={h.head}
                        bins={h.x_ds}
                        maxVal={1}
                        label={`H${h.head}`}
                      />
                    ))}
                  </motion.div>
                );
              })}
            </div>
            <div className="space-y-3">
              <span className="text-xs font-bold text-cyan-400 uppercase tracking-wider">
                {secondaryResult.concept}
              </span>
              {secondaryResult.words.map((fp, i) => {
                const layer = fp.layers.find(
                  (l) => l.layer === comparisonLayer,
                );
                if (!layer) return null;
                return (
                  <motion.div
                    key={fp.word}
                    className="glass-card p-3"
                    initial={{ opacity: 0, x: 10 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: i * 0.05 }}
                  >
                    <span className="text-xs font-mono font-bold block mb-1 text-cyan-400">
                      {fp.word}
                    </span>
                    {layer.heads.map((h) => (
                      <HeatmapRow
                        key={h.head}
                        bins={h.x_ds}
                        maxVal={1}
                        label={`H${h.head}`}
                      />
                    ))}
                  </motion.div>
                );
              })}
            </div>
          </div>
        </motion.div>
      )}
    </div>
  );
}

/* ================================================================== */
/*  5. NEURON GRAPH ‚Äî top-K neurons as nodes, edges for shared         */
/* ================================================================== */

interface GraphNode {
  id: string;
  label: string;
  type: "neuron" | "word";
  color: string;
  radius: number;
  x: number;
  y: number;
  val?: number;
}
interface GraphEdge {
  source: string;
  target: string;
  color: string;
  width: number;
}

function NeuronGraphView({
  result,
  selectedLayer,
}: {
  result: FingerprintResult;
  selectedLayer: number;
}) {
  const svgRef = useRef<SVGSVGElement>(null);
  const [dims, setDims] = useState({ w: 800, h: 500 });

  useEffect(() => {
    const el = svgRef.current?.parentElement;
    if (!el) return;
    const obs = new ResizeObserver((entries) => {
      const { width } = entries[0].contentRect;
      setDims({ w: width, h: Math.max(400, Math.min(width * 0.6, 600)) });
    });
    obs.observe(el);
    return () => obs.disconnect();
  }, []);

  const { nodes, edges } = useMemo(() => {
    const nodeMap = new Map<string, GraphNode>();
    const edgeList: GraphEdge[] = [];
    const words = result.words;

    words.forEach((w, i) => {
      const color = WORD_COLORS[i % WORD_COLORS.length];
      nodeMap.set(`w_${w.word}`, {
        id: `w_${w.word}`,
        label: w.word,
        type: "word",
        color,
        radius: 18,
        x: 80,
        y: (dims.h / (words.length + 1)) * (i + 1),
      });
    });

    const neuronAgg = new Map<
      string,
      {
        head: number;
        idx: number;
        totalVal: number;
        wordCount: number;
        words: Set<string>;
      }
    >();
    words.forEach((w) => {
      const layer = w.layers.find((l) => l.layer === selectedLayer);
      if (!layer) return;
      layer.heads.forEach((h) => {
        h.top_neurons.forEach((n) => {
          const key = `n_H${h.head}_N${n.idx}`;
          const existing = neuronAgg.get(key);
          if (existing) {
            existing.totalVal += n.val;
            existing.wordCount++;
            existing.words.add(w.word);
          } else {
            neuronAgg.set(key, {
              head: h.head,
              idx: n.idx,
              totalVal: n.val,
              wordCount: 1,
              words: new Set([w.word]),
            });
          }
        });
      });
    });

    const sortedNeurons = [...neuronAgg.entries()].sort((a, b) =>
      b[1].wordCount !== a[1].wordCount
        ? b[1].wordCount - a[1].wordCount
        : b[1].totalVal - a[1].totalVal,
    );
    const topNeurons = sortedNeurons.slice(0, 25);
    const maxVal = Math.max(1e-6, ...topNeurons.map(([, n]) => n.totalVal));

    topNeurons.forEach(([key, info], i) => {
      const isShared = info.wordCount >= 2;
      const r = 8 + (info.totalVal / maxVal) * 12;
      nodeMap.set(key, {
        id: key,
        label: `H${info.head}_N${info.idx}`,
        type: "neuron",
        color: isShared ? "#10b981" : "#6b7280",
        radius: r,
        x: dims.w - 100,
        y: (dims.h / (topNeurons.length + 1)) * (i + 1),
        val: info.totalVal,
      });
      info.words.forEach((wName) => {
        const wIdx = words.findIndex((w) => w.word === wName);
        const wordColor = WORD_COLORS[wIdx % WORD_COLORS.length];
        edgeList.push({
          source: `w_${wName}`,
          target: key,
          color: isShared ? "#10b98166" : `${wordColor}33`,
          width: isShared ? 2 : 1,
        });
      });
    });

    // d3-force layout
    const nodeArr = [...nodeMap.values()];
    const sim = d3
      .forceSimulation(nodeArr as any[])
      .force(
        "link",
        d3
          .forceLink(
            edgeList.map((e) => ({
              source: nodeArr.findIndex((n) => n.id === e.source),
              target: nodeArr.findIndex((n) => n.id === e.target),
            })),
          )
          .distance(120),
      )
      .force("charge", d3.forceManyBody().strength(-80))
      .force("center", d3.forceCenter(dims.w / 2, dims.h / 2))
      .force(
        "collide",
        d3.forceCollide<any>().radius((d: any) => (d.radius || 10) + 6),
      )
      .stop();
    for (let i = 0; i < 150; i++) sim.tick();
    nodeArr.forEach((n) => {
      n.x = Math.max(n.radius + 5, Math.min(dims.w - n.radius - 5, n.x));
      n.y = Math.max(n.radius + 5, Math.min(dims.h - n.radius - 5, n.y));
    });

    return { nodes: nodeArr, edges: edgeList };
  }, [result, selectedLayer, dims]);

  const nodeById = useMemo(() => {
    const m = new Map<string, GraphNode>();
    nodes.forEach((n) => m.set(n.id, n));
    return m;
  }, [nodes]);
  const sharedCount = nodes.filter(
    (n) => n.type === "neuron" && n.color === "#10b981",
  ).length;

  return (
    <motion.div
      className="glass-card p-4"
      initial={{ opacity: 0, scale: 0.95 }}
      animate={{ opacity: 1, scale: 1 }}
    >
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <Network size={16} className="text-bdh-accent" />
          <span className="text-sm font-semibold">
            Neuron Connectivity Graph ‚Äî Layer {selectedLayer}
          </span>
        </div>
        <div className="flex items-center gap-3 text-xs text-gray-400">
          <span>
            <span className="inline-block w-2 h-2 rounded-full bg-emerald-500 mr-1" />
            Shared ({sharedCount})
          </span>
          <span>
            <span className="inline-block w-2 h-2 rounded-full bg-gray-500 mr-1" />
            Unique
          </span>
        </div>
      </div>
      <svg
        ref={svgRef}
        viewBox={`0 0 ${dims.w} ${dims.h}`}
        className="w-full"
        style={{ height: dims.h }}
      >
        <defs>
          <filter id="glow">
            <feGaussianBlur stdDeviation="3" result="blur" />
            <feMerge>
              <feMergeNode in="blur" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>
        </defs>
        {edges.map((e, i) => {
          const s = nodeById.get(e.source);
          const t = nodeById.get(e.target);
          if (!s || !t) return null;
          return (
            <motion.line
              key={`e-${i}`}
              x1={s.x}
              y1={s.y}
              x2={t.x}
              y2={t.y}
              stroke={e.color}
              strokeWidth={e.width}
              initial={{ pathLength: 0, opacity: 0 }}
              animate={{ pathLength: 1, opacity: 1 }}
              transition={{ delay: i * 0.008, duration: 0.4 }}
            />
          );
        })}
        {nodes.map((n, i) => (
          <motion.g
            key={n.id}
            initial={{ opacity: 0, scale: 0 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: i * 0.02, duration: 0.3 }}
          >
            <circle
              cx={n.x}
              cy={n.y}
              r={n.radius}
              fill={n.color}
              fillOpacity={n.type === "word" ? 0.9 : 0.6}
              stroke={n.color}
              strokeWidth={n.type === "word" ? 2 : 1}
              strokeOpacity={0.8}
              filter={
                n.type === "neuron" && n.color === "#10b981"
                  ? "url(#glow)"
                  : undefined
              }
            />
            <text
              x={n.x}
              y={n.type === "word" ? n.y + n.radius + 14 : n.y - n.radius - 5}
              textAnchor="middle"
              fill={n.type === "word" ? n.color : "#9ca3af"}
              fontSize={n.type === "word" ? 11 : 8}
              fontFamily="monospace"
              fontWeight={n.type === "word" ? 700 : 400}
            >
              {n.label}
            </text>
          </motion.g>
        ))}
      </svg>
      <p className="text-xs text-gray-500 mt-2">
        Each word connects to its top-K most active neurons.{" "}
        <span className="text-emerald-400 font-semibold">Green neurons</span>{" "}
        fire for multiple words ‚Äî proof of shared concept encoding.
      </p>
    </motion.div>
  );
}

/* ================================================================== */
/*  SHARED NEURON PANEL ‚Äî updated for new response shape               */
/* ================================================================== */

function SharedNeuronPanel({
  neurons,
  words,
}: {
  neurons: SharedNeuron[];
  words: string[];
}) {
  if (neurons.length === 0) return null;
  return (
    <motion.div
      className="glass-card p-4"
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay: 0.2 }}
    >
      <div className="flex items-center gap-2 mb-3">
        <Sparkles size={16} className="text-bdh-accent" />
        <span className="text-sm font-semibold">Top Shared Neurons</span>
        <span className="text-xs text-gray-500 ml-auto">
          Neurons active across all {words.length} input words
        </span>
      </div>
      <div className="overflow-x-auto">
        <table className="w-full text-xs">
          <thead>
            <tr className="text-gray-500 border-b border-gray-800">
              <th className="text-left py-2 px-2">Location</th>
              <th className="text-right py-2 px-2">Mean Act.</th>
              {words.map((w, i) => (
                <th
                  key={w}
                  className="text-right py-2 px-2 font-mono"
                  style={{ color: WORD_COLORS[i % WORD_COLORS.length] }}
                >
                  {w}
                </th>
              ))}
              <th className="py-2 px-2">Strength</th>
            </tr>
          </thead>
          <tbody>
            {neurons.slice(0, 15).map((n, i) => (
              <motion.tr
                key={`${n.layer}-${n.head}-${n.neuron}`}
                className="border-b border-gray-800/50 hover:bg-gray-800/30"
                initial={{ opacity: 0, x: -10 }}
                animate={{ opacity: 1, x: 0 }}
                transition={{ delay: i * 0.03 }}
              >
                <td className="py-2 px-2 font-mono text-bdh-accent">
                  L{n.layer}_H{n.head}_N{n.neuron}
                </td>
                <td className="py-2 px-2 text-right font-mono text-gray-400">
                  {n.mean_activation.toFixed(4)}
                </td>
                {n.per_word.map((pw, wi) => (
                  <td
                    key={wi}
                    className="py-2 px-2 text-right font-mono"
                    style={{
                      color: WORD_COLORS[wi % WORD_COLORS.length],
                      opacity: pw > 0 ? 1 : 0.3,
                    }}
                  >
                    {pw.toFixed(3)}
                  </td>
                ))}
                <td className="py-2 px-2">
                  <div className="w-20 h-2 bg-gray-800 rounded-full overflow-hidden">
                    <motion.div
                      className="h-full rounded-full bg-gradient-to-r from-bdh-accent to-emerald-400"
                      initial={{ width: 0 }}
                      animate={{
                        width: `${Math.min((n.mean_activation / (neurons[0]?.mean_activation || 1)) * 100, 100)}%`,
                      }}
                      transition={{ delay: i * 0.05, duration: 0.5 }}
                    />
                  </div>
                </td>
              </motion.tr>
            ))}
          </tbody>
        </table>
      </div>
    </motion.div>
  );
}

/* ================================================================== */
/*  MAIN PAGE                                                          */
/* ================================================================== */

export function MonosemanticityPage() {
  const [words, setWords] = useState<string[]>([]);
  const [input, setInput] = useState("");
  const [conceptName, setConceptName] = useState("custom");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [result, setResult] = useState<FingerprintResult | null>(null);
  const [selectedLayer, setSelectedLayer] = useState(0);
  const [viewTab, setViewTab] = useState<ViewTab>("fingerprint");

  const addWord = useCallback(() => {
    const w = input.trim().toLowerCase();
    if (w && !words.includes(w)) {
      setWords((prev) => [...prev, w]);
      setInput("");
    }
  }, [input, words]);

  const removeWord = (w: string) =>
    setWords((prev) => prev.filter((x) => x !== w));

  const loadPreset = (preset: (typeof PRESETS)[number]) => {
    setWords(preset.words);
    setConceptName(preset.name);
    setResult(null);
  };

  const probeModel = async () => {
    if (words.length < 2) return;
    setLoading(true);
    setError(null);
    try {
      const resp = await analysis.neuronFingerprint(conceptName, words);
      setResult(resp.data as FingerprintResult);
      setSelectedLayer(0);
    } catch (err: any) {
      setError(
        err.response?.data?.detail || err.message || "Failed to probe model",
      );
    } finally {
      setLoading(false);
    }
  };

  const probeSecondary = async (
    name: string,
    wds: string[],
  ): Promise<FingerprintResult | null> => {
    try {
      const resp = await analysis.neuronFingerprint(name, wds);
      return resp.data as FingerprintResult;
    } catch {
      return null;
    }
  };

  const globalMax = useMemo(() => {
    if (!result) return 1;
    let mx = 0;
    result.words.forEach((w) =>
      w.layers.forEach((l) =>
        l.heads.forEach((h) => {
          h.x_ds.forEach((v) => {
            if (v > mx) mx = v;
          });
        }),
      ),
    );
    return mx || 1;
  }, [result]);

  const nLayers = result?.model_info.n_layers ?? 0;

  return (
    <div className="min-h-screen p-6 md:p-8 max-w-[1600px] mx-auto">
      {/* Header */}
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        className="mb-6"
      >
        <h1 className="text-3xl font-bold mb-1">
          <span className="gradient-text">Monosemanticity</span> Explorer
        </h1>
        <p className="text-gray-400 text-sm max-w-2xl">
          Probe the BDH model with same-concept words and watch{" "}
          <span className="text-white font-medium">
            the same neurons light up
          </span>
          . Five views reveal shared concept encoding from heatmaps to graphs.
        </p>
      </motion.div>

      {/* Input Section */}
      <motion.div
        className="glass-card p-5 mb-6"
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
      >
        <div className="flex flex-wrap gap-2 mb-4">
          <span className="text-xs text-gray-500 self-center mr-1">
            Quick presets:
          </span>
          {PRESETS.map((p) => (
            <button
              key={p.id}
              onClick={() => loadPreset(p)}
              className={`px-3 py-1.5 rounded-lg text-xs font-medium border transition-all ${conceptName === p.name ? "border-bdh-accent bg-bdh-accent/20 text-bdh-accent" : "border-gray-700 bg-gray-800/50 text-gray-400 hover:border-gray-600 hover:text-gray-200"}`}
            >
              <span className="mr-1">{p.icon}</span>
              {p.name}
            </button>
          ))}
        </div>
        <div className="flex flex-wrap items-center gap-2 p-3 bg-gray-900/60 rounded-xl border border-gray-700/50 min-h-[52px]">
          <AnimatePresence>
            {words.map((w) => (
              <motion.span
                key={w}
                className="inline-flex items-center gap-1 px-3 py-1 bg-bdh-accent/20 border border-bdh-accent/40 rounded-full text-sm text-bdh-accent font-medium"
                initial={{ scale: 0, opacity: 0 }}
                animate={{ scale: 1, opacity: 1 }}
                exit={{ scale: 0, opacity: 0 }}
                layout
              >
                {w}
                <button
                  onClick={() => removeWord(w)}
                  className="ml-0.5 hover:text-red-400 transition-colors"
                >
                  <X size={12} />
                </button>
              </motion.span>
            ))}
          </AnimatePresence>
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyDown={(e) => {
              if (e.key === "Enter") addWord();
              if (e.key === "Backspace" && !input && words.length)
                removeWord(words[words.length - 1]);
            }}
            placeholder={
              words.length === 0
                ? 'Type a word and press Enter (e.g. "dollar")'
                : "Add another word‚Ä¶"
            }
            className="flex-1 min-w-[140px] bg-transparent outline-none text-sm text-gray-200 placeholder-gray-600"
          />
          <button
            onClick={addWord}
            disabled={!input.trim()}
            className="p-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white disabled:opacity-30 transition-all"
          >
            <Plus size={16} />
          </button>
        </div>
        <div className="flex items-center gap-3 mt-3">
          <div className="flex items-center gap-2 flex-1">
            <label className="text-xs text-gray-500 shrink-0">
              Concept label:
            </label>
            <input
              type="text"
              value={conceptName}
              onChange={(e) => setConceptName(e.target.value)}
              className="px-3 py-1.5 bg-gray-900/50 border border-gray-700 rounded-lg text-sm text-gray-200 outline-none focus:border-bdh-accent/50 w-40"
            />
          </div>
          <button
            onClick={probeModel}
            disabled={words.length < 2 || loading}
            className="btn-primary flex items-center gap-2 disabled:opacity-40 disabled:cursor-not-allowed"
          >
            {loading ? (
              <Loader2 size={16} className="animate-spin" />
            ) : (
              <Brain size={16} />
            )}
            {loading ? "Probing‚Ä¶" : "Probe Model"}
          </button>
        </div>
        {error && (
          <motion.p
            className="mt-2 text-sm text-red-400"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
          >
            {error}
          </motion.p>
        )}
      </motion.div>

      {/* Results */}
      <AnimatePresence mode="wait">
        {result && (
          <motion.div
            key="results"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
          >
            {/* Toolbar */}
            <div className="flex items-center justify-between mb-5 flex-wrap gap-3">
              {viewTab !== "crossConcept" && (
                <div className="flex items-center gap-1 bg-gray-900/60 rounded-xl p-1 border border-gray-800/50">
                  <Layers size={14} className="text-gray-500 ml-2 mr-1" />
                  {Array.from({ length: nLayers }, (_, i) => (
                    <button
                      key={i}
                      onClick={() => setSelectedLayer(i)}
                      className={`px-3 py-1.5 rounded-lg text-xs font-mono font-semibold transition-all ${selectedLayer === i ? "bg-bdh-accent text-white shadow-lg shadow-bdh-accent/30" : "text-gray-400 hover:text-gray-200 hover:bg-gray-800/50"}`}
                    >
                      L{i}
                    </button>
                  ))}
                </div>
              )}
              <div className="flex gap-1 bg-gray-900/60 rounded-xl p-1 border border-gray-800/50">
                {VIEW_TABS.map((tab) => (
                  <button
                    key={tab.id}
                    onClick={() => setViewTab(tab.id)}
                    className={`px-3 py-1.5 rounded-lg text-xs font-semibold flex items-center gap-1.5 transition-all ${viewTab === tab.id ? "bg-bdh-accent text-white" : "text-gray-400 hover:text-gray-200"}`}
                  >
                    {tab.icon}
                    <span className="hidden sm:inline">{tab.label}</span>
                  </button>
                ))}
              </div>
            </div>

            {/* Active view */}
            <div className="mb-6">
              <AnimatePresence mode="wait">
                {viewTab === "fingerprint" && (
                  <motion.div
                    key="fp"
                    initial={{ opacity: 0, x: -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    exit={{ opacity: 0, x: 20 }}
                    transition={{ duration: 0.2 }}
                  >
                    <FingerprintView
                      result={result}
                      selectedLayer={selectedLayer}
                      globalMax={globalMax}
                    />
                  </motion.div>
                )}
                {viewTab === "similarity" && (
                  <motion.div
                    key="sim"
                    initial={{ opacity: 0, x: -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    exit={{ opacity: 0, x: 20 }}
                    transition={{ duration: 0.2 }}
                  >
                    <SimilarityView
                      result={result}
                      selectedLayer={selectedLayer}
                    />
                  </motion.div>
                )}
                {viewTab === "intersection" && (
                  <motion.div
                    key="inter"
                    initial={{ opacity: 0, x: -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    exit={{ opacity: 0, x: 20 }}
                    transition={{ duration: 0.2 }}
                  >
                    <IntersectionView
                      result={result}
                      selectedLayer={selectedLayer}
                      globalMax={globalMax}
                    />
                  </motion.div>
                )}
                {viewTab === "crossConcept" && (
                  <motion.div
                    key="cross"
                    initial={{ opacity: 0, x: -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    exit={{ opacity: 0, x: 20 }}
                    transition={{ duration: 0.2 }}
                  >
                    <CrossConceptView
                      primaryResult={result}
                      onProbeSecondary={probeSecondary}
                    />
                  </motion.div>
                )}
                {viewTab === "neuronGraph" && (
                  <motion.div
                    key="graph"
                    initial={{ opacity: 0, x: -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    exit={{ opacity: 0, x: 20 }}
                    transition={{ duration: 0.2 }}
                  >
                    <NeuronGraphView
                      result={result}
                      selectedLayer={selectedLayer}
                    />
                  </motion.div>
                )}
              </AnimatePresence>
            </div>

            {/* Shared neurons table */}
            <SharedNeuronPanel
              neurons={result.shared_neurons}
              words={result.words.map((w) => w.word)}
            />

            {/* Insight banner */}
            <motion.div
              className="mt-6 glass-card p-5"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.3 }}
            >
              <h3 className="text-sm font-semibold mb-2 flex items-center gap-2">
                <Sparkles size={16} className="text-bdh-accent" />
                What You're Seeing
              </h3>
              <p className="text-gray-400 text-sm leading-relaxed">
                The{" "}
                <span className="text-amber-400 font-semibold">
                  x-path (encoder)
                </span>{" "}
                is the clean concept fingerprint. It maps raw input through a
                sparse encoder (ReLU) producing{" "}
                <span className="text-white">8,192 neurons per head</span>.
                Same-concept words activate the <em>same sparse subset</em> ‚Äî
                that's monosemanticity. The{" "}
                <span className="text-emerald-400 font-semibold">
                  Similarity Matrix
                </span>{" "}
                quantifies it: &gt;0.7 cosine similarity proves shared encoding.
                The{" "}
                <span className="text-cyan-400 font-semibold">
                  Neuron Graph
                </span>{" "}
                shows shared neurons as green nodes connecting multiple words.
                Unlike transformers whose neurons are{" "}
                <span className="text-red-400">polysemantic</span>, BDH produces{" "}
                <span className="text-bdh-accent font-semibold">
                  interpretable synapses
                </span>{" "}
                where you can point at a neuron and say{" "}
                <em>"this is the currency neuron."</em>
              </p>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Empty state */}
      {!result && !loading && (
        <motion.div
          className="flex flex-col items-center justify-center py-20 text-gray-600"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.4 }}
        >
          <Brain size={64} className="mb-4 opacity-30" />
          <p className="text-lg font-medium mb-1">
            Enter words and probe the model
          </p>
          <p className="text-sm text-gray-700">
            Add at least 2 words from the same category, then click{" "}
            <span className="text-bdh-accent">Probe Model</span>
          </p>
        </motion.div>
      )}
    </div>
  );
}
